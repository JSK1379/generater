# 📱 BLE 智慧社交聊天 - 使用指南

歡迎使用 **BLE 智慧社交聊天應用**！這是一款創新的社交應用程式，讓您能夠透過藍牙技術發現身邊的人，並與他們建立即時聊天連接。結合先進的 AI 技術，為您提供更智慧、更有趣的社交體驗。

## 🎯 應用特色

✨ **藍牙發現身邊朋友** - 無需網路，直接透過藍牙找到附近的使用者  
🤖 **AI 智慧聊天助手** - Google Gemini AI 協助您找到話題和對話建議  
🎨 **AI 客製化頭像** - 根據您的喜好自動生成獨特頭像  
🔒 **隱私保護設計** - 對話分析完全匿名化處理  
📍 **位置軌跡記錄** - 可選的 GPS 位置分享功能  
⚡ **即時聊天體驗** - 快速、穩定的訊息傳送

## 🚀 快速開始

### 第一次使用

#### 1️⃣ 創建您的帳號
1. 開啟應用後，點擊底部的「設置」頁籤
2. 選擇「創建新帳號」
3. 輸入您的電子郵件地址
4. 設定您的暱稱和個人資訊

#### 2️⃣ 設定個人頭像
1. 前往「Avatar」頁籤
2. 點擊「上傳頭像」從相簿選擇照片
3. 或使用「AI 生成頭像」功能，描述您想要的風格
4. 調整並確認您的頭像

#### 3️⃣ 設定 AI 助手（可選）
1. 在「設置」頁面找到「Gemini API 設定」
2. 輸入您的 Google Gemini API 金鑰
3. AI 助手將幫助您產生對話建議

#### 4️⃣ 開啟必要權限
當應用要求時，請允許以下權限：
- **藍牙權限**：用於發現附近的使用者
- **位置權限**：用於精確的用戶探索（可選）
- **通知權限**：接收聊天訊息通知

## 📲 主要功能使用說明

### 🔍 發現附近朋友

#### 如何使用藍牙掃描
1. 確保您的手機藍牙已開啟
2. 點擊底部的「藍牙」頁籤
3. 應用會自動開始廣播您的資訊並掃描附近使用者
4. 當發現附近的人時，會顯示他們的頭像和暱稱

#### 建立新連線
1. 在掃描列表中點擊您想認識的使用者
2. 查看他們的個人資料卡
3. 點擊「發送連接請求」
4. 等待對方接受邀請後即可開始聊天

💡 **小提示**：只有同樣開啟此應用的用戶才會出現在掃描列表中

### 💬 即時聊天功能

#### 開始對話
1. 點擊底部的「聊天室」頁籤
2. 您會看到所有聊天記錄列表
3. 點選想要聊天的對象開啟聊天視窗
4. 輸入訊息並點擊發送按鈕

#### 使用 AI 聊天助手
1. 在聊天過程中，如果不知道說什麼
2. 點擊聊天介面的「🤖」按鈕
3. AI 會分析對話內容並提供聊天建議
4. 選擇合適的建議或繼續自由發揮

🔒 **隱私保護**：AI 分析時會將您和對方的名稱替換為「你」「他」，保護身份隱私

### 🎨 個性化頭像功能

#### AI 頭像生成
1. 前往「Avatar」頁籤
2. 點擊「AI 生成頭像」
3. 用文字描述您想要的頭像風格（例如：「可愛的貓咪風格」）
4. AI 會根據您的描述生成獨特頭像
5. 滿意的話點擊「使用此頭像」

#### 手動上傳頭像
1. 在「Avatar」頁籤點擊「上傳頭像」
2. 從手機相簿選擇照片
3. 調整裁剪範圍到合適大小
4. 確認上傳並設為個人頭像

### 📍 位置追蹤功能（可選）

#### 開啟 GPS 追蹤
1. 前往「設置」頁面
2. 找到「GPS 背景設定」
3. 開啟「背景位置追蹤」
4. 選擇追蹤頻率和精度
5. 您的位置軌跡會自動記錄

#### 查看位置歷史
1. 在「測試」頁籤中選擇「GPS 相關功能」
2. 點擊「獲取今日 GPS 歷史」
3. 查看您今天的活動軌跡

## ⚙️ 設定說明

### 🔐 隱私與安全設定

#### 隱私保護功能
- **對話分析匿名化**：AI 分析對話時會隱藏真實姓名
- **位置隱私**：GPS 追蹤完全可選，可隨時關閉
- **資料控制**：您可以隨時刪除聊天記錄和位置歷史

#### 藍牙廣播設定
1. 在「設置」頁面找到「BLE 廣播設定」
2. 可以控制是否廣播您的資訊給其他人
3. 關閉後其他人將無法透過藍牙發現您

### 🔔 通知設定
- **聊天通知**：接收新訊息通知
- **連接請求通知**：有人想加您好友時的通知
- **系統通知**：應用更新和重要消息

### 🤖 AI 助手設定
- **API 金鑰設定**：配置您的 Gemini AI API
- **AI 建議頻率**：控制 AI 建議出現的頻率
- **隱私模式**：確保 AI 分析完全匿名化

## 💡 使用技巧

### 提升社交體驗
1. **完整設定個人資料**：設定有趣的暱稱和頭像，增加被發現的機會
2. **善用 AI 建議**：當不知道該聊什麼時，AI 助手能提供很好的話題
3. **定期掃描**：在人群聚集的地方多使用掃描功能
4. **保持應用開啟**：只有應用在前台時才能被其他人發現

### 隱私保護建議
1. **謹慎分享位置**：GPS 功能是可選的，根據需要開啟
2. **注意公共場所**：在人多的地方使用時注意個人安全
3. **定期檢查設定**：確保隱私設定符合您的需求

## ❓ 常見問題

### Q: 為什麼我掃描不到其他人？
A: 確保：
- 您的藍牙已開啟
- 其他人也同時在使用這個應用
- 雙方都在藍牙有效範圍內（通常10-20公尺）

### Q: AI 助手需要付費嗎？
A: AI 功能需要您提供 Google Gemini API 金鑰，這可能產生 Google 的使用費用，但應用本身不收費。

### Q: 我的聊天記錄安全嗎？
A: 聊天記錄儲存在您的設備上，AI 分析時會完全匿名化處理，保護您的隱私。

### Q: 可以關閉位置追蹤嗎？
A: 當然可以！GPS 功能完全可選，您可以在設定中隨時開啟或關閉。

### Q: 如何刪除聊天記錄？
A: 目前可以在聊天室中手動刪除訊息，完整的批量刪除功能正在開發中。

## 🆘 需要幫助？

如果您在使用過程中遇到問題：

1. **檢查權限設定**：確保應用有必要的權限
2. **重啟應用**：關閉並重新開啟應用
3. **檢查網路連接**：某些功能需要網路連線
4. **更新應用**：確保使用最新版本

---

🎉 **開始您的智慧社交之旅吧！** 

透過藍牙發現身邊有趣的人，讓 AI 協助您建立更好的對話連接。記住，這個應用專注於幫助您與真實的人建立真實的連接。

<p align="center">
  ⭐ 享受您的社交體驗！ ⭐
</p>聊天 - 使用指南

歡迎使用 **BLE 智慧社交聊天應用**！這是一款革命性的社交應用程式，讓您能夠透過藍牙技術發現身邊的人，並與他們建立即時聊天連接。結合先進的 AI 技術，為您提供更智慧、更有趣的社交體驗。

## � 應用特色

✨ **藍牙發現身邊朋友** - 無需網路，直接透過藍牙找到附近的使用者  
🤖 **AI 智慧聊天助手** - Google Gemini AI 協助您找到話題和對話建議  
🎨 **AI 客製化頭像** - 根據您的喜好自動生成獨特頭像  
🔒 **隱私保護設計** - 對話分析完全匿名化處理  
📍 **位置軌跡記錄** - 可選的 GPS 位置分享功能  
⚡ **即時聊天體驗** - 快速、穩定的訊息傳送

## ✨ 主要特色

### � 智慧用戶發現系統
- **BLE 廣播與掃描**：透過藍牙低功耗技術廣播個人資訊（暱稱、用戶ID、頭像）
- **附近用戶探索**：自動掃描並顯示附近用戶的完整資料卡片
- **一鍵連接請求**：直觀的用戶介面發送好友邀請
- **設備名稱穩定**：優化的設備名稱緩存，避免掃描過程中名稱閃爍

### 🤖 AI 智慧聊天助手
- **個性化對話建議**：基於雙方用戶資料生成相關對話提示
- **隱私保護分析**：對話總結使用「你」「他」匿名化處理，保護用戶身份
- **智慧頭像生成**：透過 Gemini AI 根據用戶偏好創建個性化頭像
- **純輔助功能**：AI 僅提供分析與建議，不主動參與對話

### 💬 先進即時通訊系統
- **WebSocket 實時通訊**：低延遲、高穩定性的聊天體驗
- **智慧房間管理**：支援 `room_` 和 `friend_` 格式的多房間系統
- **樂觀更新機制**：訊息發送採用樂觀更新，提升用戶體驗
- **智慧自動滾動**：開啟聊天室自動滾動到最新訊息，含重試機制

### � 精準 GPS 位置服務
- **背景持續追蹤**：應用關閉後繼續記錄 GPS 軌跡
- **高頻率定位模式**：支援高精度位置追蹤選項
- **位置歷史查詢**：查看特定日期的詳細軌跡記錄
- **即時位置分享**：實時上傳位置資料到雲端伺服器

### 👤 完整用戶管理系統
- **郵箱認證系統**：安全的註冊登入流程
- **智慧頭像系統**：AI 生成頭像配合手動上傳選項
- **個人資料管理**：暱稱、頭像等資訊統一管理
- **用戶資料展示**：連接請求時顯示對方完整資料卡片

### 🎨 現代化用戶介面
- **五頁面導覽架構**：BLE 掃描、頭像設定、聊天室、測試工具、系統設定
- **響應式設計**：完美適配各種螢幕尺寸和設備型號
- **隱私優先設計**：所有 AI 功能均採用隱私保護設計
- **安全區域適配**：支援有瀏海或導覽列的現代手機

## 🏗️ 技術架構

### 前端技術棧
- **Flutter 3.0+** - Google 跨平台行動應用開發框架
- **Dart 2.17+** - 高效能程式語言
- **Material Design** - Google 現代化設計系統

### AI 與機器學習
- **Google Gemini API** - 先進的大語言模型
- **智慧對話分析** - 個性化聊天建議生成
- **AI 頭像生成** - 基於用戶偏好的頭像創建
- **隱私保護處理** - 匿名化對話分析技術

### 核心依賴套件
```yaml
dependencies:
  # 🔵 BLE 藍牙功能
  flutter_blue_plus: ^1.35.5         # BLE 掃描與連接
  flutter_ble_peripheral: ^1.2.6     # BLE 廣播功能
  
  # 💬 即時通訊
  web_socket_channel: ^2.4.0         # WebSocket 實時通訊
  
  # 🤖 AI 整合
  google_generative_ai: ^0.4.3       # Gemini AI API
  
  # 📍 位置服務
  geolocator: ^14.0.1                # GPS 定位功能
  workmanager: ^0.9.0                # 背景任務管理
  
  # 📱 用戶介面與功能
  image_picker: ^1.0.7               # 圖片選擇器
  shared_preferences: ^2.0.0         # 本地資料儲存
  permission_handler: ^12.0.0+1      # 系統權限管理
  flutter_local_notifications: ^19.4.0  # 本地通知系統
  
  # 🌐 網路通訊
  http: ^1.2.1                       # HTTP API 請求
  
  # 🔧 開發輔助
  provider: ^6.1.1                   # 狀態管理
  path_provider: ^2.0.0              # 檔案路徑處理
```
### 後端 API 架構
- **用戶認證服務** - JWT 令牌驗證的安全登入系統
- **即時聊天後端** - WebSocket 伺服器支援多房間管理
- **GPS 資料服務** - 位置資料收集、處理與歷史查詢
- **AI 服務整合** - Gemini API 代理與安全金鑰管理
- **檔案上傳服務** - 頭像與媒體檔案雲端儲存

### 安全與隱私設計
- **API 金鑰保護** - 敏感配置採用 `assets/secret.json` 安全儲存
- **匿名化處理** - AI 對話分析完全匿名化，使用「你」「他」代替真實身份
- **本地資料加密** - 使用 SharedPreferences 安全儲存用戶偏好
- **權限最小化** - 僅請求功能必需的系統權限

## 📂 專案架構

```
lib/
├── main.dart                          # 🚀 應用程式入口點與初始化
├── main_tab_page.dart                 # 📱 主要分頁導覽與 UI 架構
├── api_config.dart                    # ⚙️ API 端點配置與環境設定
│
├── 🔵 BLE 藍牙功能模組
│   ├── ble_scan_body.dart             # 設備掃描主介面與用戶發現
│   ├── ble_scan_helper.dart           # BLE 掃描邏輯與連接管理
│   └── settings_ble_helper.dart       # BLE 廣播設定與偏好管理
│
├── 💬 智慧聊天系統
│   ├── chat_service.dart              # 🧠 聊天核心邏輯與 AI 整合
│   ├── chat_service_singleton.dart    # 聊天服務單例管理
│   ├── chat_models.dart               # 聊天資料模型定義
│   ├── chat_page.dart                 # 聊天室介面與智慧滾動
│   ├── chat_room_list_page.dart       # 聊天室列表與管理
│   ├── chat_room_open_manager.dart    # 聊天室開啟狀態管理
│   ├── websocket_service.dart         # WebSocket 通訊服務
│   └── websocket_service_fixed.dart   # 優化版 WebSocket 實作
│
├── 🤖 AI 服務模組
│   ├── gemini_service.dart            # Gemini AI 服務整合
│   ├── secure_gemini_service.dart     # 安全金鑰管理的 AI 服務
│   └── gemini_api_key_setup_page.dart # AI API 金鑰設定頁面
│
├── 📍 GPS 定位系統
│   ├── gps_service.dart                        # GPS 核心邏輯
│   ├── background_gps_service.dart             # 背景位置追蹤服務
│   ├── enhanced_foreground_location_service.dart # 增強前台定位
│   ├── foreground_location_service.dart        # 基礎前台定位
│   ├── gps_background_settings_page.dart       # GPS 背景設定介面
│   └── high_frequency_gps_test_page.dart       # 高頻 GPS 測試工具
│
├── 👤 用戶管理系統
│   ├── user_api_service.dart          # 用戶 API 服務與資料處理
│   ├── user_id_setup_page_new.dart    # 用戶註冊與設定頁面
│   ├── user_login_page.dart           # 用戶登入驗證介面
│   └── user_profile_edit_page.dart    # 用戶資料編輯與管理
│
├── 🎨 頭像與媒體系統
│   ├── avatar_page.dart               # 🤖 AI 頭像生成與編輯
│   ├── avatar_utils.dart              # 頭像處理工具與算法
│   ├── avatar_generation_service.dart # AI 頭像生成服務
│   ├── image_api_service.dart         # 圖片上傳與處理服務
│   └── image_upload_status.md         # 圖片功能狀態文檔
│
├── 🔧 系統設定與工具
│   ├── settings_page.dart             # 系統偏好設定頁面
│   └── _test_tab.dart                 # 開發者測試工具頁面
│
└── 📋 文檔與狀態
    ├── AI_INTEGRATION_COMPLETE.md     # AI 整合完成文檔
    ├── GEMINI_SETUP.md               # Gemini AI 設定指南
    └── GPS_TEST_COMMUTE_BYPASS.md    # GPS 測試繞過文檔
```

### 🔑 核心檔案說明

| 檔案 | 功能描述 | 特色技術 |
|------|---------|----------|
| `chat_service.dart` | 聊天核心邏輯 | AI 輔助分析、匿名化處理、樂觀更新 |
| `ble_scan_body.dart` | BLE 用戶發現 | 穩定設備名稱、完整資料卡片顯示 |
| `avatar_page.dart` | AI 頭像生成 | Gemini AI 整合、英文提示詞處理 |
| `secure_gemini_service.dart` | AI 安全服務 | 安全金鑰管理、API 代理 |
| `chat_page.dart` | 聊天室介面 | 智慧自動滾動、重試機制 |

## 🚀 快速開始

### 環境需求
- Flutter 3.0 或更高版本
- Dart 2.17 或更高版本
- Android Studio / VS Code
- Android SDK（Android 開發）
- Xcode（iOS 開發）

### 安裝步驟

1. **克隆專案**
   ```bash
   git clone <repository-url>
   cd flutter_ble_test
   ```

2. **安裝依賴**
   ```bash
   flutter pub get
   ```

3. **配置 API 端點**
   
   編輯 `lib/api_config.dart`，設定您的後端 API 地址：
   ```dart
   class ApiConfig {
     static const String _baseUrl = 'https://your-api-server.com';
     static const String _wsBaseUrl = 'wss://your-websocket-server.com';
   }
   ```

4. **設定權限**

   **Android (`android/app/src/main/AndroidManifest.xml`)**
   ```xml
   <uses-permission android:name="android.permission.BLUETOOTH" />
   <uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />
   <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
   <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
   ```

   **iOS (`ios/Runner/Info.plist`)**
   ```xml
   <key>NSBluetoothAlwaysUsageDescription</key>
   <string>此應用需要藍牙權限來掃描附近的設備</string>
   <key>NSLocationWhenInUseUsageDescription</key>
   <string>此應用需要位置權限來記錄 GPS 軌跡</string>
   ```

5. **運行應用**
   ```bash
   flutter run
   ```

## 💡 使用指南

### 📱 主要功能頁面

#### 1. **藍牙掃描頁** (🔵 藍牙)
- 點擊掃描按鈕開始搜尋附近的 BLE 設備
- 查看發現的用戶暱稱和頭像
- 點擊用戶發送連接請求

#### 2. **頭像設定頁** (🎨 Avatar)
- 上傳和編輯個人頭像
- 設定個人暱稱
- 頭像會透過 BLE 廣播給其他用戶

#### 3. **聊天室頁** (💬 聊天室)
- 查看所有聊天記錄
- 點擊進入特定聊天室
- 支援文字訊息和圖片（部分功能）

#### 4. **測試工具頁** (🔬 測試)
- 用戶註冊和登入測試
- GPS 位置上傳和查詢
- 系統功能調試工具

#### 5. **設定頁** (⚙️ 設置)
- BLE 廣播開關
- GPS 背景追蹤設定
- 系統偏好設定

### 🔧 開發者工具

#### GPS 測試功能
```dart
// 上傳當前 GPS 位置
await _uploadCurrentGPS(context);

// 查詢今日 GPS 記錄
await _getTodayGPSHistory(context);
```

#### WebSocket 連接測試
```dart
// 建立 WebSocket 連接並註冊用戶
final chatService = ChatServiceSingleton.instance;
await chatService.connectAndRegister(wsUrl, roomId, userId);
```

## 🔧 配置說明

### API 端點配置 (`lib/api_config.dart`)

```dart
class ApiConfig {
  // 🌐 基礎API端點
  static const String _baseUrl = 'https://your-backend-api.com';
  static const String _wsBaseUrl = 'wss://your-websocket-server.com';
  
  // 📍 GPS相關端點
  static String get gpsLocation => '$_baseUrl/gps/location';
  static String gpsUserLocations(String userId) => '$_baseUrl/gps/locations/$userId';
  
  // 💬 聊天相關端點
  static String get wsUrl => '$_wsBaseUrl/ws';
  static String friendsChatHistory(String roomId) => '$_baseUrl/friends/chat_history/$roomId';
  
  // 👤 用戶相關端點
  static String get userRegister => '$_baseUrl/users/register';
}
```

### 權限配置

應用需要以下權限：
- **藍牙權限** - BLE 設備掃描和廣播
- **位置權限** - GPS 追蹤功能
- **儲存權限** - 本地資料和圖片存取
- **網路權限** - API 通訊和 WebSocket 連接

## 🚀 部署說明

### Android 打包
```bash
flutter build apk --release
# 或
flutter build appbundle --release
```

### iOS 打包
```bash
flutter build ios --release
```

### 打包前檢查
- 確保所有 API 端點指向正式環境
- 檢查權限配置完整性
- 測試核心功能正常運作

## 🤝 開發參與

歡迎參與專案開發！請遵循以下步驟：

1. Fork 此專案
2. 建立功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 建立 Pull Request

### 開發規範
- 遵循 Dart 官方代碼風格
- 為新功能添加適當的註釋
- 確保代碼通過 `flutter analyze` 檢查
- 測試核心功能後再提交

## 📄 授權

此專案採用 MIT 授權條款 - 詳見 [LICENSE](LICENSE) 文件

## 🐛 問題回報

如果您發現任何問題或有功能建議，請：

1. 檢查 [Issues](https://github.com/JSK1379/generator/issues) 是否已有相關問題
2. 如果沒有，請建立新的 Issue 並詳細描述問題
3. 提供復現步驟和設備資訊

## 📧 聯絡資訊

- **專案維護者**: JSK1379
- **GitHub**: [https://github.com/JSK1379/generator](https://github.com/JSK1379/generator)

---

<p align="center">
  ⭐ 如果這個專案對您有幫助，請給我們一個星星！ ⭐
</p>